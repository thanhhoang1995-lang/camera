<!DOCTYPE html>
<html lang="vi">
<head>
  <title>Dashboard Quản lý Camera - Nâng cấp</title>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <link rel='stylesheet' href='https://unpkg.com/leaflet/dist/leaflet.css' />
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' />
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css' />
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: bold; font-size: 1.3rem; }
    #map { height: 60vh; width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    #sidebar { max-height: 55vh; overflow-y: auto; background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card { border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0; font-weight: bold; padding: 0.75rem; font-size: 0.9rem; }
    .card-body { padding: 0.75rem; }
    .stats-box { text-align: center; padding: 10px; border-radius: 8px; color: white; margin-bottom: 0; }
    .stats-box h3 { margin: 0.25rem 0; font-size: 1.5rem; }
    .stats-box p { margin: 0; font-size: 0.75rem; }
    .stats-online { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stats-offline { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
    .stats-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .online { color: #11998e; font-weight: bold; }
    .offline { color: #eb3349; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    th, td { border: 1px solid #dee2e6; padding: 6px; text-align: left; }
    th { background-color: #f1f3f5; font-weight: bold; }
    tr:hover { background-color: #f8f9fa; }
    button { margin: 2px; }
    input[type='number'], input[type='text'], select { width: 100%; font-size: 0.85rem; padding: 0.25rem; }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
    .search-box { position: relative; }
    .chart-container { position: relative; height: 200px; margin: 10px 0; }
    .container-fluid { padding: 0.5rem; }
    .row { margin-right: -0.25rem; margin-left: -0.25rem; }
    .col-md-6, .col-md-8, .col-md-12 { padding-right: 0.25rem; padding-left: 0.25rem; }
    .pin-mode #map { cursor: crosshair; }
    .pin-mode-active { background-color: #ffc107 !important; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .navbar-brand { font-size: 0.9rem; }
      .navbar-subtitle { font-size: 0.65rem; }
      #map { height: 50vh; }
      .stats-box { padding: 8px; }
      .stats-box h3 { font-size: 1.2rem; }
      .stats-box p { font-size: 0.65rem; }
      .card-header { font-size: 0.8rem; padding: 0.5rem; }
      .card-body { padding: 0.5rem; }
      .btn-sm { padding: 0.2rem 0.4rem; font-size: 0.65rem; }
      table { font-size: 0.7rem; }
      th, td { padding: 4px; }
      .chart-container { height: 150px; }
      .modal-body { font-size: 0.85rem; }
      .modal-body input, .modal-body select { font-size: 0.75rem; padding: 0.3rem; }
      .table-responsive { font-size: 0.75rem; }
    }

    @media (max-width: 480px) {
      .navbar { padding: 0.4rem 0.5rem; }
      .navbar-brand { font-size: 0.8rem; }
      #map { height: 45vh; }
      .stats-box { padding: 6px; }
      .stats-box h3 { font-size: 1rem; }
      .stats-box p { font-size: 0.6rem; }
      .card { margin-bottom: 10px; }
      .card-header { font-size: 0.75rem; padding: 0.4rem; }
      .card-body { padding: 0.4rem; }
      .btn-sm { padding: 0.15rem 0.3rem; font-size: 0.6rem; }
      table { font-size: 0.65rem; }
      th, td { padding: 3px; }
      input[type='number'], input[type='text'], select { font-size: 0.75rem; }
      .search-box input { font-size: 0.8rem; }
      .btn-group { width: 100%; }
      .btn-group .btn { flex: 1; }
      .chart-container { height: 120px; margin: 5px 0; }
      .container-fluid { padding: 0.25rem; }

      /* Ẩn cột Lat (5) và Lng (6) trên điện thoại */
      table thead th:nth-child(5),
      table tbody td:nth-child(5),
      table thead th:nth-child(6),
      table tbody td:nth-child(6) {
        display: none;
      }

      /* Ẩn nút xóa trong bảng trên điện thoại */
      table .btn-danger {
        display: none;
      }
    }
  </style>
</head>
<body>
<!-- Navbar -->
<nav class='navbar navbar-dark'>
  <div class='container-fluid'>
    <span class='navbar-brand'><i class='bi bi-camera-video'></i> Quản lý Camera</span>
    <span class='text-white'>Phường Lâm Viên - Đà Lạt</span>
  </div>
</nav>

<div class='container-fluid mt-2'>
  <!-- Statistics Cards -->
  <div class='row mb-3'>
    <div class='col-md-6 col-12 mb-1 mb-md-0'>
      <div class='row'>
        <div class='col-md-12 col-12'>
          <div class='stats-box stats-total'>
            <h3 id='totalCount'>0</h3>
            <p>Tổng số Camera</p>
          </div>
        </div>
      </div>
    </div>
    <div class='col-md-6 col-12'>
      <div class='row'>
        <div class='col-md-6 col-6'>
          <div class='stats-box stats-online'>
            <h3 id='onlineCount'>0</h3>
            <p>Online</p>
          </div>
        </div>
        <div class='col-md-6 col-6'>
          <div class='stats-box stats-offline'>
            <h3 id='offlineCount'>0</h3>
            <p>Offline</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class='row'>
    <div class='col-md-8 col-12'>
      <div class='card'>
        <div class='card-header'>
          <i class='bi bi-map'></i> Bản đồ
        </div>
        <div class='card-body p-0'>
          <div id='map' style='margin: 5px;'></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Management Panel -->
  <div class='row mt-4'>
    <div class='col-md-12'>
      <div class='card'>
        <div class='card-header'>
          <i class='bi bi-list-ul'></i> Quản lý Camera
        </div>
        <div class='card-body'>
          <!-- Search and Filter -->
          <div class='row mb-2'>
            <div class='col-md-6 col-12'>
              <div class='search-box'>
                <input type='text' id='searchInput' class='form-control form-control-sm' placeholder='Tìm kiếm...'>
              </div>
            </div>
            <div class='col-md-6 col-12'>
              <div class='btn-group w-100' role='group' style='gap: 2px;'>
                <button class='btn btn-sm btn-outline-success' style='flex:1;' onclick='toggleFilter("online")'>
                  <input type='checkbox' id='filterOnline' checked style='width:auto;'> Online
                </button>
                <button class='btn btn-sm btn-outline-danger' style='flex:1;' onclick='toggleFilter("offline")'>
                  <input type='checkbox' id='filterOffline' checked style='width:auto;'> Offline
                </button>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class='row mb-2'>
            <div class='col-12'>
              <div class='d-flex flex-wrap gap-1'>
                <button class='btn btn-success btn-sm' onclick='addCamera()'>
                  <i class='bi bi-plus-circle'></i> Thêm
                </button>
                <button class='btn btn-primary btn-sm' onclick='locateUser()'>
                  <i class='bi bi-cursor-fill'></i> Vị trí tôi
                </button>
                <button class='btn btn-warning btn-sm' id='pinBtn' onclick='togglePinMode()'>
                  <i class='bi bi-geo-alt'></i> Ghim vị trí
                </button>
                <button class='btn btn-info btn-sm' onclick='syncToGitHub()' title='Đồng bộ dữ liệu với GitHub'>
                  <i class='bi bi-cloud-arrow-up'></i> Đồng bộ DL
                </button>
                <button class='btn btn-info btn-sm' onclick='exportCSV()'>
                  <i class='bi bi-download'></i> Xuất
                </button>
                <button class='btn btn-primary btn-sm' onclick='document.getElementById("importFile").click()'>
                  <i class='bi bi-upload'></i> Nhập
                </button>
                <button class='btn btn-secondary btn-sm' onclick='showSettings()' title='Cài đặt GitHub'>
                  <i class='bi bi-gear'></i> Cài đặt
                </button>
                <button class='btn btn-danger btn-sm' onclick='clearStorageData()' title='Xóa tất cả dữ liệu lưu trữ'>
                  <i class='bi bi-trash'></i> Xóa dữ liệu
                </button>
                <input type='file' id='importFile' accept='text/csv,.csv' style='display:none;' onchange='importCSV(event)' multiple='false'>
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class='table-responsive'>
            <table class='table table-hover table-sm mb-0'>
              <thead>
                <tr><th>#</th><th>Tên</th><th>IP</th><th>Địa chỉ</th><th>Vĩ độ</th><th>Kinh độ</th><th>Trạng thái</th><th>Hành động</th></tr>
              </thead>
              <tbody id='cameraTable'></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class='modal fade' id='editModal' tabindex='-1'>
  <div class='modal-dialog modal-sm'>
    <div class='modal-content'>
      <div class='modal-header bg-primary text-white'>
        <h5 class='modal-title'><i class='bi bi-pencil-square'></i> Chỉnh sửa Camera</h5>
        <button type='button' class='btn-close btn-close-white' data-bs-dismiss='modal'></button>
      </div>
      <div class='modal-body'>
        <input type='hidden' id='editId'>
        <div class='mb-2'>
          <label class='form-label small'>Tên Camera:</label>
          <input type='text' id='editName' class='form-control form-control-sm'>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>IP:</label>
          <input type='text' id='editIP' class='form-control form-control-sm'>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>Địa chỉ:</label>
          <input type='text' id='editAddress' class='form-control form-control-sm'>
        </div>
        <div class='row'>
          <div class='col-6 mb-2'>
            <label class='form-label small'>Vĩ độ:</label>
            <input type='number' step='0.00001' id='editLat' class='form-control form-control-sm'>
          </div>
          <div class='col-6 mb-2'>
            <label class='form-label small'>Kinh độ:</label>
            <input type='number' step='0.00001' id='editLng' class='form-control form-control-sm'>
          </div>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>Trạng thái:</label>
          <select id='editStatus' class='form-control form-control-sm'>
            <option value='online'>Online</option>
            <option value='offline'>Offline</option>
          </select>
        </div>
      </div>
      <div class='modal-footer'>
        <button type='button' class='btn btn-secondary btn-sm' data-bs-dismiss='modal'>Hủy</button>
        <button type='button' class='btn btn-primary btn-sm' onclick='saveEdit()'>
          <i class='bi bi-check-circle'></i> Lưu
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Camera Modal -->
<div class='modal fade' id='addCameraModal' tabindex='-1'>
  <div class='modal-dialog modal-sm'>
    <div class='modal-content'>
      <div class='modal-header bg-success text-white'>
        <h5 class='modal-title'><i class='bi bi-plus-circle'></i> Thêm Camera Mới</h5>
        <button type='button' class='btn-close btn-close-white' data-bs-dismiss='modal'></button>
      </div>
      <div class='modal-body'>
        <div class='mb-2'>
          <label class='form-label small'>Tên Camera:</label>
          <input type='text' id='addName' class='form-control form-control-sm' placeholder='Camera 1'>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>IP:</label>
          <input type='text' id='addIP' class='form-control form-control-sm' placeholder='192.168.1.1'>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>Địa chỉ:</label>
          <input type='text' id='addAddress' class='form-control form-control-sm' placeholder='Địa chỉ camera'>
        </div>
        <div class='row'>
          <div class='col-6 mb-2'>
            <label class='form-label small'>Vĩ độ:</label>
            <input type='number' step='0.00001' id='addLat' class='form-control form-control-sm' readonly>
          </div>
          <div class='col-6 mb-2'>
            <label class='form-label small'>Kinh độ:</label>
            <input type='number' step='0.00001' id='addLng' class='form-control form-control-sm' readonly>
          </div>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>Trạng thái:</label>
          <select id='addStatus' class='form-control form-control-sm'>
            <option value='online'>Online</option>
            <option value='offline'>Offline</option>
          </select>
        </div>
      </div>
      <div class='modal-footer'>
        <button type='button' class='btn btn-secondary btn-sm' data-bs-dismiss='modal'>Hủy</button>
        <button type='button' class='btn btn-success btn-sm' onclick='saveNewCamera()'>
          <i class='bi bi-check-circle'></i> Thêm
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class='modal fade' id='settingsModal' tabindex='-1'>
  <div class='modal-dialog modal-sm'>
    <div class='modal-content'>
      <div class='modal-header bg-secondary text-white'>
        <h5 class='modal-title'><i class='bi bi-gear'></i> Cài đặt GitHub</h5>
        <button type='button' class='btn-close btn-close-white' data-bs-dismiss='modal'></button>
      </div>
      <div class='modal-body'>
        <p class='text-muted small'>Để lưu dữ liệu trên GitHub, cần cấu hình thông tin sau:</p>
        
        <div class='alert alert-info mb-2' role='alert'>
          <small><strong>Hướng dẫn nhanh:</strong><br>
          1. Vào <a href='https://gist.github.com/' target='_blank' class='alert-link'>gist.github.com</a> → Tạo Gist mới<br>
          2. <strong>Gist ID:</strong> Copy từ URL: <code>gist.github.com/username/<u>abc123...</u></code><br>
          3. <strong>Token:</strong> Tạo tại <a href='https://github.com/settings/tokens' target='_blank' class='alert-link'>settings/tokens</a> (scope: gist)<br>
          4. Dán vào đây và nhấn Lưu
          </small>
        </div>

        <div class='mb-2'>
          <label class='form-label small'>GitHub Personal Token:</label>
          <input type='password' id='githubToken' class='form-control form-control-sm' placeholder='ghp_xxxxxxxxxxxxxxx'>
          <small class='text-muted'>Token với quyền gist</small>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>Gist ID:</label>
          <input type='text' id='gistId' class='form-control form-control-sm' placeholder='abc123def456...'>
          <small class='text-muted'>ID hoặc URL đầy đủ từ GitHub Gist</small>
        </div>
        <div class='mb-3'>
          <button class='btn btn-sm btn-info w-100' onclick='testGitHubConnection()'>
            <i class='bi bi-cloud-check'></i> Kiểm tra kết nối
          </button>
        </div>
      </div>
      <div class='modal-footer'>
        <button type='button' class='btn btn-secondary btn-sm' data-bs-dismiss='modal'>Hủy</button>
        <button type='button' class='btn btn-primary btn-sm' onclick='saveGitHubSettings()'>
          <i class='bi bi-check-circle'></i> Lưu
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src='https://unpkg.com/leaflet/dist/leaflet.js'></script>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'></script>

<script>
  const map = L.map('map').setView([11.9404, 108.4583], 13);
  L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
    attribution: '&copy; Google Maps'
  }).addTo(map);

  const onlineIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', iconSize: [32, 32], iconAnchor: [16, 32] });
  const offlineIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize: [32, 32], iconAnchor: [16, 32] });
  const tempIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', iconSize: [32, 32], iconAnchor: [16, 32] });

  let cameras = [];
  let isPinMode = false;
  let tempMarker = null;

  // GitHub Gist Configuration
  const STORAGE_KEYS = {
    cameras: 'cameras',
    githubToken: 'github_token',
    gistId: 'gist_id'
  };

  // CORS Proxies để hỗ trợ các trình duyệt
  const CORS_PROXIES = [
    'https://corsproxy.io/?',
    'https://api.allorigins.win/raw?url='
  ];

  let currentProxyIndex = 0;
  let syncAbortController = null; // Để hủy sync

  // Tạo fetch với timeout
  function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
    
    return fetch(url, { ...options, signal: controller.signal })
      .finally(() => clearTimeout(timeoutId));
  }

  // Hàm trích xuất Gist ID từ URL hoặc ID trực tiếp
  function parseGistId(input) {
    input = input.trim();
    // Nếu là URL, trích xuất ID
    if (input.includes('gist.github.com')) {
      const parts = input.split('/');
      return parts[parts.length - 1].split('#')[0]; // Lấy ID cuối cùng, bỏ phần anchor
    }
    // Nếu là ID trực tiếp
    return input;
  }

  function getGitHubSettings() {
    return {
      token: localStorage.getItem(STORAGE_KEYS.githubToken),
      gistId: localStorage.getItem(STORAGE_KEYS.gistId)
    };
  }

  function saveGitHubSettings() {
    const token = document.getElementById('githubToken').value.trim();
    let gistId = document.getElementById('gistId').value.trim();
    
    if (!token || !gistId) {
      alert('Vui lòng điền đầy đủ thông tin');
      return;
    }
    
    // Parse Gist ID (hỗ trợ cả URL và ID trực tiếp)
    gistId = parseGistId(gistId);
    
    // Xác thực định dạng Gist ID (phải là 32 ký tự hex)
    if (!/^[a-f0-9]{32}$/.test(gistId)) {
      alert('❌ Gist ID không hợp lệ!\n\nGist ID phải:\n- Là chuỗi 32 ký tự hex\n- Hoặc là URL đầy đủ từ GitHub\n\nVí dụ:\n✓ abc123def456...\n✓ gist.github.com/username/abc123def456...');
      return;
    }
    
    localStorage.setItem(STORAGE_KEYS.githubToken, token);
    localStorage.setItem(STORAGE_KEYS.gistId, gistId);
    
    // Tự động tạo file cameras.json nếu chưa có
    initializeGistFile(token, gistId);
  }

  async function initializeGistFile(token, gistId) {
    try {
      const response = await fetchWithTimeout(
        `https://api.github.com/gists/${gistId}`,
        {
          method: 'PATCH',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            files: {
              'cameras.json': {
                content: '[]'
              }
            }
          })
        },
        10000 // 10 giây timeout
      );

      console.log('Response status:', response.status);

      if (response.ok) {
        alert('✓ Cài đặt đã được lưu và file cameras.json đã được tạo!');
        bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
      } else if (response.status === 401) {
        alert('✗ Token không hợp lệ hoặc đã hết hạn\n\nKiểm tra:\n1. Token có chính xác?\n2. Token có scope "gist"?\n3. Token đã hết hạn?');
      } else if (response.status === 403) {
        alert('✗ Token không có quyền truy cập Gist\n\nKiểm tra:\n1. Tạo token mới với scope "gist"\n2. Token có bị từ chối quyền?');
      } else if (response.status === 404) {
        alert('✗ Gist không tìm thấy\n\nKiểm tra:\n1. Gist ID có chính xác?\n2. Gist có tồn tại trên GitHub?');
      } else {
        alert(`✗ Lỗi HTTP ${response.status}\n\nKiểm tra:\n1. Gist ID: ${gistId}\n2. Token có đúng quyền?\n3. Thử lại sau vài giây`);
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        alert('✗ Kết nối timeout - kiểm tra Internet');
      } else {
        console.error('Chi tiết lỗi:', error);
        alert('✗ Lỗi: ' + error.message + '\n\nKiểm tra:\n1. Kết nối Internet\n2. Token và Gist ID chính xác');
      }
    }
  }

  function showSettings() {
    const settings = getGitHubSettings();
    document.getElementById('githubToken').value = settings.token || '';
    document.getElementById('gistId').value = settings.gistId || '';
    new bootstrap.Modal(document.getElementById('settingsModal')).show();
  }

  async function testGitHubConnection() {
    const settings = getGitHubSettings();
    
    if (!settings.token || !settings.gistId) {
      alert('Vui lòng điền đầy đủ thông tin trước');
      return;
    }

    try {
      const response = await fetchWithTimeout(
        `https://api.github.com/gists/${settings.gistId}`,
        {
          headers: {
            'Authorization': `token ${settings.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        },
        10000 // 10 giây timeout
      );

      if (response.ok) {
        alert('✓ Kết nối GitHub thành công!');
        currentProxyIndex = 0;
      } else if (response.status === 401) {
        alert('✗ Token không hợp lệ hoặc đã hết hạn');
      } else if (response.status === 404) {
        alert('✗ Gist ID không tìm thấy!\n\nKiểm tra:\n1. Gist ID có chính xác?\n2. Có phải Gist của tài khoản GitHub hiện tại?\n3. Token có đúng quyền gist?');
      } else {
        alert('✗ Lỗi kết nối: ' + response.statusText);
      }
    } catch (error) {
      console.error('Lỗi chi tiết:', error);
      if (error.name === 'AbortError') {
        alert('✗ Kết nối timeout - kiểm tra Internet');
      } else {
        alert('✗ Lỗi kết nối: ' + error.message + '\n\nKiểm tra:\n1. Kết nối Internet\n2. Token và Gist ID chính xác\n3. Thử lại sau vài giây');
      }
    }
  }

  // Hàm hợp nhất dữ liệu (Merge Strategy)
  function mergeCameraLists(localList, serverList) {
    const map = new Map();
    // 1. Đưa dữ liệu server vào map trước
    serverList.forEach(c => map.set(c.id, c));
    
    // 2. Hợp nhất với dữ liệu local
    localList.forEach(localCam => {
      const serverCam = map.get(localCam.id);
      // Nếu local mới hơn hoặc server không có -> Dùng local
      if (!serverCam || (localCam.updatedAt || 0) >= (serverCam.updatedAt || 0)) {
        map.set(localCam.id, localCam);
      }
    });
    return Array.from(map.values());
  }

  async function syncToGitHub() {
    const settings = getGitHubSettings();
    
    if (!settings.token || !settings.gistId) {
      alert('Vui lòng cấu hình GitHub trước (Cài đặt > Cài đặt GitHub)');
      showSettings();
      return;
    }

    const syncBtn = document.querySelector('button[onclick="syncToGitHub()"]');
    const originalContent = syncBtn ? syncBtn.innerHTML : '';
    
    if (syncBtn) {
      syncBtn.disabled = true;
      syncBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang đồng bộ...';
    }

    try {
      await performSyncWithRetry(settings, 0);
      
      // Thông báo thành công
      const notif = document.createElement('div');
      notif.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 4px; font-size: 14px; z-index: 9999; box-shadow: 0 4px 6px rgba(0,0,0,0.2);';
      notif.innerHTML = `<i class="bi bi-check-circle"></i> Đồng bộ thành công!`;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 4000);
    } catch (error) {
      console.error('Sync error:', error);
      alert('✗ Lỗi sync: ' + error.message + '\n\nKiểm tra:\n1. Token hợp lệ?\n2. Gist ID chính xác?\n3. Kết nối Internet?');
    } finally {
      if (syncBtn) {
        syncBtn.disabled = false;
        syncBtn.innerHTML = originalContent || '<i class="bi bi-cloud-arrow-up"></i> Đồng bộ DL';
      }
    }
  }

  async function performSyncWithRetry(settings, retryCount) {
    const MAX_RETRIES = 5;
    
    // 1. Tải dữ liệu từ Server
    const getResponse = await fetchWithTimeout(
      `https://api.github.com/gists/${settings.gistId}?t=${Date.now()}`, // Cache busting
      { headers: { 'Authorization': `token ${settings.token}` } },
      10000
    );
    
    let serverCameras = [];
    if (getResponse.ok) {
      const gist = await getResponse.json();
      if (gist.files['cameras.json']) {
        serverCameras = JSON.parse(gist.files['cameras.json'].content || '[]');
      }
    } else {
      throw new Error('Không thể kết nối đến GitHub');
    }

    // 2. Hợp nhất
    cameras = mergeCameraLists(cameras, serverCameras);
    saveCameras();
    renderMarkers(); renderTable(); updateStats();

    // 3. Đẩy lên Server
    const gistContent = JSON.stringify(cameras);
    await fetchWithTimeout(
      `https://api.github.com/gists/${settings.gistId}`,
      {
        method: 'PATCH',
        headers: {
          'Authorization': `token ${settings.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          files: { 'cameras.json': { content: gistContent } }
        })
      },
      30000
    );

    // 4. KIỂM TRA LẠI (Verification)
    // Chờ ngẫu nhiên 0.5s - 1.5s để tránh xung đột liên tục
    await new Promise(r => setTimeout(r, 500 + Math.random() * 1000));

    const verifyResponse = await fetchWithTimeout(
      `https://api.github.com/gists/${settings.gistId}?t=${Date.now()}`,
      { headers: { 'Authorization': `token ${settings.token}` } },
      10000
    );

    if (verifyResponse.ok) {
      const verifyGist = await verifyResponse.json();
      const verifyContent = verifyGist.files['cameras.json'] ? verifyGist.files['cameras.json'].content : '[]';
      const verifyCameras = JSON.parse(verifyContent);

      // Kiểm tra xem dữ liệu của mình có bị người khác ghi đè không
      const isDataLost = cameras.some(localCam => {
        const serverCam = verifyCameras.find(c => c.id == localCam.id);
        // Nếu server không có camera này HOẶC server có bản cũ hơn -> Mất dữ liệu
        return !serverCam || (localCam.updatedAt || 0) > (serverCam.updatedAt || 0);
      });

      if (isDataLost) {
        if (retryCount < MAX_RETRIES) {
          console.warn(`Phát hiện xung đột dữ liệu (lần ${retryCount + 1}), đang thử lại...`);
          await performSyncWithRetry(settings, retryCount + 1);
        } else {
          throw new Error('Hệ thống đang bận, vui lòng thử lại sau ít phút.');
        }
      } else {
        // Nếu mọi thứ ổn, cập nhật lại lần cuối để đảm bảo đồng bộ nhất
        cameras = mergeCameraLists(cameras, verifyCameras);
        saveCameras();
        renderMarkers(); renderTable(); updateStats();
      }
    }
  }

  async function loadFromGitHub() {
    const settings = getGitHubSettings();
    
    if (!settings.token || !settings.gistId) {
      return; // GitHub chưa được cấu hình
    }

    try {
      const response = await fetchWithTimeout(
        `https://api.github.com/gists/${settings.gistId}`,
        {
          headers: {
            'Authorization': `token ${settings.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        },
        10000 // 10 giây timeout
      );

      if (response.ok) {
        const gist = await response.json();
        if (gist.files['cameras.json']) {
          const content = gist.files['cameras.json'].content;
          const data = JSON.parse(content);
          if (Array.isArray(data) && data.length > 0) {
            // Hợp nhất thay vì ghi đè khi tải trang
            cameras = mergeCameraLists(cameras, data);
            saveCameras();
            console.log('✓ Dữ liệu đã được hợp nhất từ GitHub');
          }
        }
      } else if (response.status === 401) {
        console.warn('GitHub Token không hợp lệ');
      }
    } catch (error) {
      console.log('Không thể tải từ GitHub:', error.message);
    }
  }

  // Hàm tải dữ liệu từ localStorage
  async function loadCameras() {
    // Cố gắng tải từ GitHub trước
    await loadFromGitHub();
    
    const stored = localStorage.getItem(STORAGE_KEYS.cameras);
    if (stored) {
      cameras = JSON.parse(stored);
    }
  }

  // Hàm lưu dữ liệu vào localStorage
  function saveCameras() {
    try {
      localStorage.setItem(STORAGE_KEYS.cameras, JSON.stringify(cameras));
      showSaveNotification();
      console.log('✓ Dữ liệu đã được lưu vào localStorage');
    } catch (error) {
      console.error('Lỗi lưu dữ liệu:', error);
      alert('Không thể lưu dữ liệu. Vui lòng kiểm tra cài đặt trình duyệt của bạn.');
    }
  }

  // Hàm hiển thị thông báo lưu thành công (chỉ trên mobile/desktop nhỏ)
  function showSaveNotification() {
    const notif = document.createElement('div');
    notif.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 4px; font-size: 14px; z-index: 9999; animation: slideIn 0.3s ease-in-out;';
    notif.textContent = '✓ Dữ liệu đã được lưu';
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 2000);
  }

  // Hàm xóa dữ liệu từ localStorage
  function clearStorageData() {
    if (confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu camera không?')) {
      localStorage.removeItem(STORAGE_KEYS.cameras);
      alert('Dữ liệu đã được xóa.');
      location.reload();
    }
  }

  function generateRandomCameras(total = 200) {
    const centerLat = 11.9404;
    const centerLng = 108.4583;
    const maxDelta = 0.2;
    for (let i = 1; i <= total; i++) {
      const lat = centerLat + (Math.random() - 0.5) * maxDelta;
      const lng = centerLng + (Math.random() - 0.5) * maxDelta;
      const status = Math.random() > 0.3 ? 'online' : 'offline';
      const ip = `192.168.${Math.floor((i - 1) / 254)}.${((i - 1) % 254) + 1}`;
      cameras.push({ id: i, name: `Camera ${i}`, ip, address: `Địa chỉ ${i}`, lat, lng, status });
    }
  }

  const markers = L.layerGroup();

  function updateStats() {
    const activeCameras = cameras.filter(c => !c.deleted);
    const total = activeCameras.length;
    const online = activeCameras.filter(c => c.status === 'online').length;
    const offline = total - online;
    document.getElementById('totalCount').textContent = total;
    document.getElementById('onlineCount').textContent = online;
    document.getElementById('offlineCount').textContent = offline;
  }

  function renderMarkers() {
    markers.clearLayers();
    const showOnline = document.getElementById('filterOnline').checked;
    const showOffline = document.getElementById('filterOffline').checked;
    cameras.filter(cam => !cam.deleted && ((cam.status === 'online' && showOnline) || (cam.status === 'offline' && showOffline)))
      .forEach(cam => {
        const marker = L.marker([cam.lat, cam.lng], { icon: cam.status === 'online' ? onlineIcon : offlineIcon });
        marker.bindPopup(`<b>${cam.name}</b><br>${cam.address}`);
        markers.addLayer(marker);
      });
    map.addLayer(markers);
  }

  function renderTable() {
    const tbody = document.getElementById('cameraTable');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const showOnline = document.getElementById('filterOnline').checked;
    const showOffline = document.getElementById('filterOffline').checked;
    tbody.innerHTML = '';
    let rowNum = 1;
    cameras.filter(cam => {
      if (cam.deleted) return false;
      const matchesSearch = cam.name.toLowerCase().includes(searchTerm) || cam.ip.toLowerCase().includes(searchTerm);
      const matchesStatus = (cam.status === 'online' && showOnline) || (cam.status === 'offline' && showOffline);
      return matchesSearch && matchesStatus;
    }).forEach(cam => {
      const row = document.createElement('tr');
      row.style.cursor = 'pointer';
      row.onclick = () => focusCamera(cam);
      row.innerHTML = `<td>${rowNum++}</td><td>${cam.name}</td><td>${cam.ip}</td><td>${cam.address}</td>
        <td>${cam.lat.toFixed(4)}</td><td>${cam.lng.toFixed(4)}</td>
        <td><span class='${cam.status}'>${cam.status}</span></td>
        <td><button class='btn btn-sm btn-warning' onclick='event.stopPropagation(); editCamera("${cam.id}")'>Sửa</button>
        <button class='btn btn-sm btn-danger' onclick='event.stopPropagation(); deleteCamera("${cam.id}")'>Xóa</button></td>`;
      tbody.appendChild(row);
    });
  }

  function editCamera(id) {
    // Sử dụng so sánh lỏng (==) để hỗ trợ cả ID số cũ và ID chuỗi mới
    const cam = cameras.find(c => c.id == id);
    document.getElementById('editId').value = id;
    document.getElementById('editName').value = cam.name;
    document.getElementById('editIP').value = cam.ip;
    document.getElementById('editAddress').value = cam.address;
    document.getElementById('editLat').value = cam.lat;
    document.getElementById('editLng').value = cam.lng;
    document.getElementById('editStatus').value = cam.status;
    new bootstrap.Modal(document.getElementById('editModal')).show();
  }

  function saveEdit() {
    const id = document.getElementById('editId').value;
    const cam = cameras.find(c => c.id == id);
    cam.name = document.getElementById('editName').value;
    cam.ip = document.getElementById('editIP').value;
    cam.address = document.getElementById('editAddress').value;
    cam.lat = parseFloat(document.getElementById('editLat').value);
    cam.lng = parseFloat(document.getElementById('editLng').value);
    cam.status = document.getElementById('editStatus').value;
    cam.updatedAt = Date.now(); // Cập nhật thời gian sửa
    saveCameras();
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    renderMarkers(); renderTable(); updateStats();
  }

  function locateUser() {
    if (!navigator.geolocation) {
      alert('Trình duyệt không hỗ trợ định vị.');
      return;
    }

    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang tìm...';

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        // Xóa marker cũ nếu có
        if (window.userLocationMarker) map.removeLayer(window.userLocationMarker);
        if (window.userLocationCircle) map.removeLayer(window.userLocationCircle);

        // Tạo marker vị trí người dùng (chấm xanh dương)
        window.userLocationMarker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: 'user-location-marker',
            html: '<div style="background-color: #4285F4; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"></div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          })
        }).addTo(map);

        window.userLocationCircle = L.circle([lat, lng], {
          radius: accuracy,
          color: '#4285F4',
          fillColor: '#4285F4',
          fillOpacity: 0.15,
          weight: 1
        }).addTo(map);

        map.flyTo([lat, lng], 16);
        btn.disabled = false;
        btn.innerHTML = originalContent;
      },
      (error) => {
        console.error(error);
        let msg = 'Lỗi lấy vị trí.';
        if (error.code === 1) msg = 'Vui lòng cho phép truy cập vị trí.';
        else if (error.code === 2) msg = 'Vị trí không khả dụng.';
        else if (error.code === 3) msg = 'Hết thời gian chờ.';
        alert(msg);
        btn.disabled = false;
        btn.innerHTML = originalContent;
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  function togglePinMode() {
    isPinMode = !isPinMode;
    const pinBtn = document.getElementById('pinBtn');
    if (isPinMode) {
      pinBtn.classList.add('pin-mode-active');
      document.getElementById('map').parentElement.classList.add('pin-mode');
      map.dragging.disable();
    } else {
      pinBtn.classList.remove('pin-mode-active');
      document.getElementById('map').parentElement.classList.remove('pin-mode');
      map.dragging.enable();
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
    }
  }

  function saveNewCamera() {
    const name = document.getElementById('addName').value.trim();
    const ip = document.getElementById('addIP').value.trim();
    const address = document.getElementById('addAddress').value.trim();
    const lat = parseFloat(document.getElementById('addLat').value);
    const lng = parseFloat(document.getElementById('addLng').value);
    const status = document.getElementById('addStatus').value;

    if (!name || !ip || !address) {
      alert('Vui lòng điền đầy đủ thông tin');
      return;
    }

    // Tạo ID duy nhất dựa trên thời gian + chuỗi ngẫu nhiên để tránh trùng lặp khi nhiều người cùng thêm
    const newId = 'cam_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    cameras.push({ id: newId, name, ip, address, lat, lng, status, updatedAt: Date.now() });
    saveCameras();

    // Reset form
    document.getElementById('addName').value = '';
    document.getElementById('addIP').value = '';
    document.getElementById('addAddress').value = '';
    document.getElementById('addLat').value = '';
    document.getElementById('addLng').value = '';
    document.getElementById('addStatus').value = 'online';

    bootstrap.Modal.getInstance(document.getElementById('addCameraModal')).hide();
    renderMarkers(); renderTable(); updateStats();

    // Tắt chế độ ghim
    if (isPinMode) {
      togglePinMode();
    }
  }

  function deleteCamera(id) {
    // Xóa mềm (Soft Delete) để đồng bộ được việc xóa
    const cam = cameras.find(c => c.id == id);
    if (cam) {
      cam.deleted = true;
      cam.updatedAt = Date.now();
      saveCameras();
      renderMarkers(); renderTable(); updateStats();
    }
  }

  function addCamera() {
    // Reset form
    document.getElementById('addName').value = '';
    document.getElementById('addIP').value = '';
    document.getElementById('addAddress').value = '';
    document.getElementById('addLat').value = '';
    document.getElementById('addLng').value = '';
    document.getElementById('addStatus').value = 'offline';
    new bootstrap.Modal(document.getElementById('addCameraModal')).show();
  }

  function exportCSV() {
    let csv = 'Tên,IP,Địa chỉ,Vĩ độ,Kinh độ,Trạng thái\n';
    cameras.filter(c => !c.deleted).forEach(cam => {
      csv += `"${cam.name}","${cam.ip}","${cam.address}",${cam.lat.toFixed(5)},${cam.lng.toFixed(5)},"${cam.status}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'cameras.csv';
    link.click();
  }

  function importCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const lines = e.target.result.split('\n').slice(1);
      const newCameras = [];
      lines.forEach((line, index) => {
        if (line.trim()) {
          const cols = line.split(',').map(col => col.replace(/"/g, '').trim());
          if (cols.length >= 6) {
            // Tạo ID duy nhất cho file import
            const id = 'import_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2, 5);
            newCameras.push({ id: id, name: cols[0], ip: cols[1], address: cols[2],
              lat: parseFloat(cols[3]), lng: parseFloat(cols[4]), status: cols[5], updatedAt: Date.now() });
          }
        }
      });
      cameras = cameras.concat(newCameras);
      saveCameras();
      document.getElementById('importFile').value = '';
      renderMarkers(); renderTable(); updateStats();
      alert(`Đã nhập ${newCameras.length} camera`);
    };
    reader.readAsText(file, 'UTF-8');
  }

  function toggleFilter(type) {
    const checkbox = document.getElementById('filter' + type.charAt(0).toUpperCase() + type.slice(1));
    checkbox.checked = !checkbox.checked;
    renderMarkers(); renderTable();
  }

  // Event listener cho map click trong chế độ ghim
  map.on('click', function(e) {
    if (!isPinMode) return;

    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // Xóa marker tạm thời cũ
    if (tempMarker) {
      map.removeLayer(tempMarker);
    }

    // Thêm marker tạm thời với màu vàng
    tempMarker = L.marker([lat, lng], { icon: tempIcon });
    tempMarker.addTo(map);

    // Điền tọa độ vào form
    document.getElementById('addLat').value = lat.toFixed(5);
    document.getElementById('addLng').value = lng.toFixed(5);

    // Mở modal thêm camera
    new bootstrap.Modal(document.getElementById('addCameraModal')).show();
  });

  document.getElementById('filterOnline').addEventListener('change', () => { renderMarkers(); renderTable(); updateStats(); });
  document.getElementById('filterOffline').addEventListener('change', () => { renderMarkers(); renderTable(); updateStats(); });
  document.getElementById('searchInput').addEventListener('input', () => { renderTable(); });

  // Event khi modal đóng lại
  document.getElementById('addCameraModal').addEventListener('hidden.bs.modal', function() {
    if (tempMarker) {
      map.removeLayer(tempMarker);
      tempMarker = null;
    }
  });

  document.addEventListener('DOMContentLoaded', async function() {
    await loadCameras();
    renderMarkers(); renderTable(); updateStats();
  });

  function focusCamera(cam) {
    map.setView([cam.lat, cam.lng], 17);
    const popup = L.popup()
      .setLatLng([cam.lat, cam.lng])
      .setContent(`<b>${cam.name}</b><br>${cam.address}`)
      .openOn(map);
  }
</script>
</body>
</html>
