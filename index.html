<!DOCTYPE html>
<html lang="vi">
<head>
  <title>Dashboard Qu·∫£n l√Ω Camera - N√¢ng c·∫•p</title>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <link rel='stylesheet' href='https://unpkg.com/leaflet/dist/leaflet.css' />
  <link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css' />
  <link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css' />
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' />
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css' />
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: bold; font-size: 1.3rem; }
    #map { height: 60vh; width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    #sidebar { max-height: 55vh; overflow-y: auto; background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card { border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0; font-weight: bold; padding: 0.75rem; font-size: 0.9rem; }
    .card-body { padding: 0.75rem; }
    .stats-box { text-align: center; padding: 10px; border-radius: 8px; color: white; margin-bottom: 0; }
    .stats-box h3 { margin: 0.25rem 0; font-size: 1.5rem; }
    .stats-box p { margin: 0; font-size: 0.75rem; }
    .stats-online { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stats-offline { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
    .stats-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .online { color: #11998e; font-weight: bold; }
    .offline { color: #eb3349; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    th, td { border: 1px solid #dee2e6; padding: 6px; text-align: left; }
    th { background-color: #f1f3f5; font-weight: bold; }
    tr:hover { background-color: #f8f9fa; }
    button { margin: 2px; }
    input[type='number'], input[type='text'], select { width: 100%; font-size: 0.85rem; padding: 0.25rem; }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
    .search-box { position: relative; }
    .chart-container { position: relative; height: 200px; margin: 10px 0; }
    .container-fluid { padding: 0.5rem; }
    .row { margin-right: -0.25rem; margin-left: -0.25rem; }
    .col-md-6, .col-md-8, .col-md-12 { padding-right: 0.25rem; padding-left: 0.25rem; }
    .pin-mode #map { cursor: crosshair; }
    .pin-mode-active { background-color: #ffc107 !important; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .navbar-brand { font-size: 0.9rem; }
      .navbar-subtitle { font-size: 0.65rem; }
      #map { height: 50vh; }
      .stats-box { padding: 8px; }
      .stats-box h3 { font-size: 1.2rem; }
      .stats-box p { font-size: 0.65rem; }
      .card-header { font-size: 0.8rem; padding: 0.5rem; }
      .card-body { padding: 0.5rem; }
      .btn-sm { padding: 0.2rem 0.4rem; font-size: 0.65rem; }
      table { font-size: 0.7rem; }
      th, td { padding: 4px; }
      .chart-container { height: 150px; }
      .modal-body { font-size: 0.85rem; }
      .modal-body input, .modal-body select { font-size: 0.75rem; padding: 0.3rem; }
      .table-responsive { font-size: 0.75rem; }
    }

    @media (max-width: 480px) {
      .navbar { padding: 0.4rem 0.5rem; }
      .navbar-brand { font-size: 0.8rem; }
      #map { height: 45vh; }
      .stats-box { padding: 6px; }
      .stats-box h3 { font-size: 1rem; }
      .stats-box p { font-size: 0.6rem; }
      .card { margin-bottom: 10px; }
      .card-header { font-size: 0.75rem; padding: 0.4rem; }
      .card-body { padding: 0.4rem; }
      .btn-sm { padding: 0.15rem 0.3rem; font-size: 0.6rem; }
      table { font-size: 0.65rem; }
      th, td { padding: 3px; }
      input[type='number'], input[type='text'], select { font-size: 0.75rem; }
      .search-box input { font-size: 0.8rem; }
      .btn-group { width: 100%; }
      .btn-group .btn { flex: 1; }
      .chart-container { height: 120px; margin: 5px 0; }
      .container-fluid { padding: 0.25rem; }

      /* ·∫®n c·ªôt Lat (5) v√† Lng (6) tr√™n ƒëi·ªán tho·∫°i */
      table thead th:nth-child(5),
      table tbody td:nth-child(5),
      table thead th:nth-child(6),
      table tbody td:nth-child(6) {
        display: none;
      }
    }
  </style>
</head>
<body>
<!-- Navbar -->
<nav class='navbar navbar-dark'>
  <div class='container-fluid'>
    <span class='navbar-brand'><i class='bi bi-camera-video'></i> Qu·∫£n l√Ω Camera</span>
    <span class='text-white'>Ph∆∞·ªùng L√¢m Vi√™n - ƒê√† L·∫°t</span>
  </div>
</nav>

<div class='container-fluid mt-2'>
  <!-- Statistics Cards -->
  <div class='row mb-3'>
    <div class='col-md-6 col-12 mb-1 mb-md-0'>
      <div class='row'>
        <div class='col-md-12 col-12'>
          <div class='stats-box stats-total'>
            <h3 id='totalCount'>0</h3>
            <p>T·ªïng s·ªë Camera</p>
          </div>
        </div>
      </div>
    </div>
    <div class='col-md-6 col-12'>
      <div class='row'>
        <div class='col-md-6 col-6'>
          <div class='stats-box stats-online'>
            <h3 id='onlineCount'>0</h3>
            <p>Online</p>
          </div>
        </div>
        <div class='col-md-6 col-6'>
          <div class='stats-box stats-offline'>
            <h3 id='offlineCount'>0</h3>
            <p>Offline</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class='row'>
    <div class='col-md-8 col-12'>
      <div class='card'>
        <div class='card-header'>
          <i class='bi bi-map'></i> B·∫£n ƒë·ªì
        </div>
        <div class='card-body p-0'>
          <div id='map' style='margin: 5px;'></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Management Panel -->
  <div class='row mt-4'>
    <div class='col-md-12'>
      <div class='card'>
        <div class='card-header'>
          <i class='bi bi-list-ul'></i> Qu·∫£n l√Ω Camera
        </div>
        <div class='card-body'>
          <!-- Search and Filter -->
          <div class='row mb-2'>
            <div class='col-md-6 col-12'>
              <div class='search-box'>
                <input type='text' id='searchInput' class='form-control form-control-sm' placeholder='T√¨m ki·∫øm...'>
              </div>
            </div>
            <div class='col-md-6 col-12'>
              <div class='btn-group w-100' role='group' style='gap: 2px;'>
                <button class='btn btn-sm btn-outline-success' style='flex:1;' onclick='toggleFilter("online")'>
                  <input type='checkbox' id='filterOnline' checked style='width:auto;'> Online
                </button>
                <button class='btn btn-sm btn-outline-danger' style='flex:1;' onclick='toggleFilter("offline")'>
                  <input type='checkbox' id='filterOffline' checked style='width:auto;'> Offline
                </button>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class='row mb-2'>
            <div class='col-12'>
              <div class='d-flex flex-wrap gap-1'>
                <button class='btn btn-success btn-sm' onclick='addCamera()'>
                  <i class='bi bi-plus-circle'></i> Th√™m
                </button>
                <button class='btn btn-warning btn-sm' id='pinBtn' onclick='togglePinMode()'>
                  <i class='bi bi-geo-alt'></i> Ghim v·ªã tr√≠
                </button>
                <button class='btn btn-info btn-sm' onclick='syncToGitHub()' title='ƒê·ªìng b·ªô d·ªØ li·ªáu v·ªõi GitHub'>
                  <i class='bi bi-cloud-arrow-up'></i> ƒê·ªìng b·ªô DL
                </button>
                <button class='btn btn-info btn-sm' onclick='exportCSV()'>
                  <i class='bi bi-download'></i> Xu·∫•t
                </button>
                <button class='btn btn-primary btn-sm' onclick='document.getElementById("importFile").click()'>
                  <i class='bi bi-upload'></i> Nh·∫≠p
                </button>
                <button class='btn btn-secondary btn-sm' onclick='showSettings()' title='C√†i ƒë·∫∑t GitHub'>
                  <i class='bi bi-gear'></i> C√†i ƒë·∫∑t
                </button>
                <button class='btn btn-danger btn-sm' onclick='clearStorageData()' title='X√≥a t·∫•t c·∫£ d·ªØ li·ªáu l∆∞u tr·ªØ'>
                  <i class='bi bi-trash'></i> X√≥a d·ªØ li·ªáu
                </button>
                <input type='file' id='importFile' accept='text/csv,.csv' style='display:none;' onchange='importCSV(event)' multiple='false'>
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class='table-responsive'>
            <table class='table table-hover table-sm mb-0'>
              <thead>
                <tr><th>#</th><th>T√™n</th><th>IP</th><th>ƒê·ªãa ch·ªâ</th><th>Vƒ© ƒë·ªô</th><th>Kinh ƒë·ªô</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr>
              </thead>
              <tbody id='cameraTable'></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class='modal fade' id='editModal' tabindex='-1'>
  <div class='modal-dialog modal-sm'>
    <div class='modal-content'>
      <div class='modal-header bg-primary text-white'>
        <h5 class='modal-title'><i class='bi bi-pencil-square'></i> Ch·ªânh s·ª≠a Camera</h5>
        <button type='button' class='btn-close btn-close-white' data-bs-dismiss='modal'></button>
      </div>
      <div class='modal-body'>
        <input type='hidden' id='editId'>
        <div class='mb-2'>
          <label class='form-label small'>T√™n Camera:</label>
          <input type='text' id='editName' class='form-control form-control-sm'>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>IP:</label>
          <input type='text' id='editIP' class='form-control form-control-sm'>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>ƒê·ªãa ch·ªâ:</label>
          <input type='text' id='editAddress' class='form-control form-control-sm'>
        </div>
        <div class='row'>
          <div class='col-6 mb-2'>
            <label class='form-label small'>Vƒ© ƒë·ªô:</label>
            <input type='number' step='0.00001' id='editLat' class='form-control form-control-sm'>
          </div>
          <div class='col-6 mb-2'>
            <label class='form-label small'>Kinh ƒë·ªô:</label>
            <input type='number' step='0.00001' id='editLng' class='form-control form-control-sm'>
          </div>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>Tr·∫°ng th√°i:</label>
          <select id='editStatus' class='form-control form-control-sm'>
            <option value='online'>Online</option>
            <option value='offline'>Offline</option>
          </select>
        </div>
      </div>
      <div class='modal-footer'>
        <button type='button' class='btn btn-secondary btn-sm' data-bs-dismiss='modal'>H·ªßy</button>
        <button type='button' class='btn btn-primary btn-sm' onclick='saveEdit()'>
          <i class='bi bi-check-circle'></i> L∆∞u
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Camera Modal -->
<div class='modal fade' id='addCameraModal' tabindex='-1'>
  <div class='modal-dialog modal-sm'>
    <div class='modal-content'>
      <div class='modal-header bg-success text-white'>
        <h5 class='modal-title'><i class='bi bi-plus-circle'></i> Th√™m Camera M·ªõi</h5>
        <button type='button' class='btn-close btn-close-white' data-bs-dismiss='modal'></button>
      </div>
      <div class='modal-body'>
        <div class='mb-2'>
          <label class='form-label small'>T√™n Camera:</label>
          <input type='text' id='addName' class='form-control form-control-sm' placeholder='Camera 1'>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>IP:</label>
          <input type='text' id='addIP' class='form-control form-control-sm' placeholder='192.168.1.1'>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>ƒê·ªãa ch·ªâ:</label>
          <input type='text' id='addAddress' class='form-control form-control-sm' placeholder='ƒê·ªãa ch·ªâ camera'>
        </div>
        <div class='row'>
          <div class='col-6 mb-2'>
            <label class='form-label small'>Vƒ© ƒë·ªô:</label>
            <input type='number' step='0.00001' id='addLat' class='form-control form-control-sm' readonly>
          </div>
          <div class='col-6 mb-2'>
            <label class='form-label small'>Kinh ƒë·ªô:</label>
            <input type='number' step='0.00001' id='addLng' class='form-control form-control-sm' readonly>
          </div>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>Tr·∫°ng th√°i:</label>
          <select id='addStatus' class='form-control form-control-sm'>
            <option value='online'>Online</option>
            <option value='offline'>Offline</option>
          </select>
        </div>
      </div>
      <div class='modal-footer'>
        <button type='button' class='btn btn-secondary btn-sm' data-bs-dismiss='modal'>H·ªßy</button>
        <button type='button' class='btn btn-success btn-sm' onclick='saveNewCamera()'>
          <i class='bi bi-check-circle'></i> Th√™m
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class='modal fade' id='settingsModal' tabindex='-1'>
  <div class='modal-dialog modal-sm'>
    <div class='modal-content'>
      <div class='modal-header bg-secondary text-white'>
        <h5 class='modal-title'><i class='bi bi-gear'></i> C√†i ƒë·∫∑t GitHub</h5>
        <button type='button' class='btn-close btn-close-white' data-bs-dismiss='modal'></button>
      </div>
      <div class='modal-body'>
        <p class='text-muted small'>ƒê·ªÉ l∆∞u d·ªØ li·ªáu tr√™n GitHub, c·∫ßn c·∫•u h√¨nh th√¥ng tin sau:</p>
        
        <div class='alert alert-info mb-2' role='alert'>
          <small><strong>H∆∞·ªõng d·∫´n nhanh:</strong><br>
          1. V√†o <a href='https://gist.github.com/' target='_blank' class='alert-link'>gist.github.com</a> ‚Üí T·∫°o Gist m·ªõi<br>
          2. <strong>Gist ID:</strong> Copy t·ª´ URL: <code>gist.github.com/username/<u>abc123...</u></code><br>
          3. <strong>Token:</strong> T·∫°o t·∫°i <a href='https://github.com/settings/tokens' target='_blank' class='alert-link'>settings/tokens</a> (scope: gist)<br>
          4. D√°n v√†o ƒë√¢y v√† nh·∫•n L∆∞u
          </small>
        </div>

        <div class='mb-2'>
          <label class='form-label small'>GitHub Personal Token:</label>
          <input type='password' id='githubToken' class='form-control form-control-sm' placeholder='ghp_xxxxxxxxxxxxxxx'>
          <small class='text-muted'>Token v·ªõi quy·ªÅn gist</small>
        </div>
        <div class='mb-2'>
          <label class='form-label small'>Gist ID:</label>
          <input type='text' id='gistId' class='form-control form-control-sm' placeholder='abc123def456...'>
          <small class='text-muted'>ID ho·∫∑c URL ƒë·∫ßy ƒë·ªß t·ª´ GitHub Gist</small>
        </div>
        <div class='mb-3'>
          <button class='btn btn-sm btn-info w-100' onclick='testGitHubConnection()'>
            <i class='bi bi-cloud-check'></i> Ki·ªÉm tra k·∫øt n·ªëi
          </button>
        </div>
      </div>
      <div class='modal-footer'>
        <button type='button' class='btn btn-secondary btn-sm' data-bs-dismiss='modal'>H·ªßy</button>
        <button type='button' class='btn btn-primary btn-sm' onclick='saveGitHubSettings()'>
          <i class='bi bi-check-circle'></i> L∆∞u
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src='https://unpkg.com/leaflet/dist/leaflet.js'></script>
<script src='https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js'></script>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'></script>

<script>
  const map = L.map('map').setView([11.9404, 108.4583], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

  const onlineIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', iconSize: [32, 32], iconAnchor: [16, 32] });
  const offlineIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize: [32, 32], iconAnchor: [16, 32] });
  const tempIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', iconSize: [32, 32], iconAnchor: [16, 32] });

  let cameras = [];
  let isPinMode = false;
  let tempMarker = null;

  // GitHub Gist Configuration
  const STORAGE_KEYS = {
    cameras: 'cameras',
    githubToken: 'github_token',
    gistId: 'gist_id'
  };

  // CORS Proxies ƒë·ªÉ h·ªó tr·ª£ c√°c tr√¨nh duy·ªát
  const CORS_PROXIES = [
    'https://corsproxy.io/?',
    'https://api.allorigins.win/raw?url='
  ];

  let currentProxyIndex = 0;
  let syncAbortController = null; // ƒê·ªÉ h·ªßy sync

  // T·∫°o fetch v·ªõi timeout
  function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
    
    return fetch(url, { ...options, signal: controller.signal })
      .finally(() => clearTimeout(timeoutId));
  }

  // H√†m tr√≠ch xu·∫•t Gist ID t·ª´ URL ho·∫∑c ID tr·ª±c ti·∫øp
  function parseGistId(input) {
    input = input.trim();
    // N·∫øu l√† URL, tr√≠ch xu·∫•t ID
    if (input.includes('gist.github.com')) {
      const parts = input.split('/');
      return parts[parts.length - 1].split('#')[0]; // L·∫•y ID cu·ªëi c√πng, b·ªè ph·∫ßn anchor
    }
    // N·∫øu l√† ID tr·ª±c ti·∫øp
    return input;
  }

  function getGitHubSettings() {
    return {
      token: localStorage.getItem(STORAGE_KEYS.githubToken),
      gistId: localStorage.getItem(STORAGE_KEYS.gistId)
    };
  }

  function saveGitHubSettings() {
    const token = document.getElementById('githubToken').value.trim();
    let gistId = document.getElementById('gistId').value.trim();
    
    if (!token || !gistId) {
      alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
      return;
    }
    
    // Parse Gist ID (h·ªó tr·ª£ c·∫£ URL v√† ID tr·ª±c ti·∫øp)
    gistId = parseGistId(gistId);
    
    // X√°c th·ª±c ƒë·ªãnh d·∫°ng Gist ID (ph·∫£i l√† 32 k√Ω t·ª± hex)
    if (!/^[a-f0-9]{32}$/.test(gistId)) {
      alert('‚ùå Gist ID kh√¥ng h·ª£p l·ªá!\n\nGist ID ph·∫£i:\n- L√† chu·ªói 32 k√Ω t·ª± hex\n- Ho·∫∑c l√† URL ƒë·∫ßy ƒë·ªß t·ª´ GitHub\n\nV√≠ d·ª•:\n‚úì abc123def456...\n‚úì gist.github.com/username/abc123def456...');
      return;
    }
    
    localStorage.setItem(STORAGE_KEYS.githubToken, token);
    localStorage.setItem(STORAGE_KEYS.gistId, gistId);
    
    // T·ª± ƒë·ªông t·∫°o file cameras.json n·∫øu ch∆∞a c√≥
    initializeGistFile(token, gistId);
  }

  async function initializeGistFile(token, gistId) {
    try {
      const response = await fetchWithTimeout(
        `https://api.github.com/gists/${gistId}`,
        {
          method: 'PATCH',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            files: {
              'cameras.json': {
                content: '[]'
              }
            }
          })
        },
        10000 // 10 gi√¢y timeout
      );

      console.log('Response status:', response.status);

      if (response.ok) {
        alert('‚úì C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c l∆∞u v√† file cameras.json ƒë√£ ƒë∆∞·ª£c t·∫°o!');
        bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
      } else if (response.status === 401) {
        alert('‚úó Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n\n\nKi·ªÉm tra:\n1. Token c√≥ ch√≠nh x√°c?\n2. Token c√≥ scope "gist"?\n3. Token ƒë√£ h·∫øt h·∫°n?');
      } else if (response.status === 403) {
        alert('‚úó Token kh√¥ng c√≥ quy·ªÅn truy c·∫≠p Gist\n\nKi·ªÉm tra:\n1. T·∫°o token m·ªõi v·ªõi scope "gist"\n2. Token c√≥ b·ªã t·ª´ ch·ªëi quy·ªÅn?');
      } else if (response.status === 404) {
        alert('‚úó Gist kh√¥ng t√¨m th·∫•y\n\nKi·ªÉm tra:\n1. Gist ID c√≥ ch√≠nh x√°c?\n2. Gist c√≥ t·ªìn t·∫°i tr√™n GitHub?');
      } else {
        alert(`‚úó L·ªói HTTP ${response.status}\n\nKi·ªÉm tra:\n1. Gist ID: ${gistId}\n2. Token c√≥ ƒë√∫ng quy·ªÅn?\n3. Th·ª≠ l·∫°i sau v√†i gi√¢y`);
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        alert('‚úó K·∫øt n·ªëi timeout - ki·ªÉm tra Internet');
      } else {
        console.error('Chi ti·∫øt l·ªói:', error);
        alert('‚úó L·ªói: ' + error.message + '\n\nKi·ªÉm tra:\n1. K·∫øt n·ªëi Internet\n2. Token v√† Gist ID ch√≠nh x√°c');
      }
    }
  }

  function showSettings() {
    const settings = getGitHubSettings();
    document.getElementById('githubToken').value = settings.token || '';
    document.getElementById('gistId').value = settings.gistId || '';
    new bootstrap.Modal(document.getElementById('settingsModal')).show();
  }

  async function testGitHubConnection() {
    const settings = getGitHubSettings();
    
    if (!settings.token || !settings.gistId) {
      alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin tr∆∞·ªõc');
      return;
    }

    try {
      const response = await fetchWithTimeout(
        `https://api.github.com/gists/${settings.gistId}`,
        {
          headers: {
            'Authorization': `token ${settings.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        },
        10000 // 10 gi√¢y timeout
      );

      if (response.ok) {
        alert('‚úì K·∫øt n·ªëi GitHub th√†nh c√¥ng!');
        currentProxyIndex = 0;
      } else if (response.status === 401) {
        alert('‚úó Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n');
      } else if (response.status === 404) {
        alert('‚úó Gist ID kh√¥ng t√¨m th·∫•y!\n\nKi·ªÉm tra:\n1. Gist ID c√≥ ch√≠nh x√°c?\n2. C√≥ ph·∫£i Gist c·ªßa t√†i kho·∫£n GitHub hi·ªán t·∫°i?\n3. Token c√≥ ƒë√∫ng quy·ªÅn gist?');
      } else {
        alert('‚úó L·ªói k·∫øt n·ªëi: ' + response.statusText);
      }
    } catch (error) {
      console.error('L·ªói chi ti·∫øt:', error);
      if (error.name === 'AbortError') {
        alert('‚úó K·∫øt n·ªëi timeout - ki·ªÉm tra Internet');
      } else {
        alert('‚úó L·ªói k·∫øt n·ªëi: ' + error.message + '\n\nKi·ªÉm tra:\n1. K·∫øt n·ªëi Internet\n2. Token v√† Gist ID ch√≠nh x√°c\n3. Th·ª≠ l·∫°i sau v√†i gi√¢y');
      }
    }
  }

  // H√†m h·ª£p nh·∫•t d·ªØ li·ªáu (Merge Strategy)
  function mergeCameraLists(localList, serverList) {
    const map = new Map();
    // 1. ƒê∆∞a d·ªØ li·ªáu server v√†o map tr∆∞·ªõc
    serverList.forEach(c => map.set(c.id, c));
    
    // 2. H·ª£p nh·∫•t v·ªõi d·ªØ li·ªáu local
    localList.forEach(localCam => {
      const serverCam = map.get(localCam.id);
      // N·∫øu local m·ªõi h∆°n ho·∫∑c server kh√¥ng c√≥ -> D√πng local
      if (!serverCam || (localCam.updatedAt || 0) >= (serverCam.updatedAt || 0)) {
        map.set(localCam.id, localCam);
      }
    });
    return Array.from(map.values());
  }

  async function syncToGitHub() {
    const settings = getGitHubSettings();
    
    if (!settings.token || !settings.gistId) {
      alert('Vui l√≤ng c·∫•u h√¨nh GitHub tr∆∞·ªõc (C√†i ƒë·∫∑t > C√†i ƒë·∫∑t GitHub)');
      showSettings();
      return;
    }

    try {
      const syncBtn = event.target.closest('button');
      syncAbortController = new AbortController();
      syncBtn.disabled = true;
      syncBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ƒêang sync... <small>(nh·∫•n ƒë·ªÉ h·ªßy)</small>';
      syncBtn.onclick = () => {
        syncAbortController.abort();
        syncBtn.disabled = false;
        syncBtn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sync';
        syncBtn.onclick = syncToGitHub;
        alert('ƒê√£ h·ªßy ƒë·ªìng b·ªô');
      };

      // B∆Ø·ªöC 1: L·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ Server v·ªÅ tr∆∞·ªõc
      const getResponse = await fetchWithTimeout(
        `https://api.github.com/gists/${settings.gistId}`,
        { headers: { 'Authorization': `token ${settings.token}` } },
        10000
      );
      
      let serverCameras = [];
      if (getResponse.ok) {
        const gist = await getResponse.json();
        if (gist.files['cameras.json']) {
          serverCameras = JSON.parse(gist.files['cameras.json'].content || '[]');
        }
      }

      // B∆Ø·ªöC 2: H·ª£p nh·∫•t (Merge)
      cameras = mergeCameraLists(cameras, serverCameras);
      saveCameras(); // L∆∞u l·∫°i k·∫øt qu·∫£ h·ª£p nh·∫•t v√†o Local
      renderMarkers(); renderTable(); updateStats(); // C·∫≠p nh·∫≠t giao di·ªán ngay

      // B∆Ø·ªöC 3: ƒê·∫©y d·ªØ li·ªáu ƒë√£ h·ª£p nh·∫•t l√™n Server
      const gistContent = JSON.stringify(cameras);
      const requestBody = JSON.stringify({
        files: {
          'cameras.json': {
            content: gistContent
          }
        }
      });
      
      console.log('üì§ B·∫Øt ƒë·∫ßu sync, d·ªØ li·ªáu:', gistContent.length, 'bytes');
      const startTime = Date.now();
      
      const response = await fetchWithTimeout(
        `https://api.github.com/gists/${settings.gistId}`,
        {
          method: 'PATCH',
          headers: {
            'Authorization': `token ${settings.token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: requestBody,
          signal: syncAbortController.signal
        },
        30000 // 30 gi√¢y timeout - ƒë·ªß cho d·ªØ li·ªáu l·ªõn
      );

      console.log('üì• Response status:', response.status);

      if (response.ok) {
        const elapsed = Date.now() - startTime;
        syncBtn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sync';
        syncBtn.disabled = false;
        syncBtn.onclick = syncToGitHub;
        console.log(`‚úì Sync th√†nh c√¥ng trong ${elapsed}ms`);
        
        // Th√¥ng b√°o th√†nh c√¥ng r√µ r√†ng
        const notif = document.createElement('div');
        notif.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 4px; font-size: 14px; z-index: 9999; box-shadow: 0 4px 6px rgba(0,0,0,0.2);';
        notif.innerHTML = `<i class="bi bi-check-circle"></i> Sync th√†nh c√¥ng!<br><small>${cameras.length} camera (${(gistContent.length/1024).toFixed(1)} KB)</small>`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 4000);
      } else if (response.status === 401) {
        throw new Error('Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n');
      } else if (response.status === 404) {
        throw new Error('Gist ID kh√¥ng t√¨m th·∫•y');
      } else {
        throw new Error('HTTP ' + response.status + ' ' + response.statusText);
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        console.log('‚úì Sync ƒë√£ b·ªã h·ªßy');
        syncBtn.disabled = false;
        syncBtn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sync';
        syncBtn.onclick = syncToGitHub;
        return;
      }
      console.error('‚ùå L·ªói sync chi ti·∫øt:', error);
      const btn = event.target.closest('button');
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Sync';
      btn.onclick = syncToGitHub;
      
      // Hi·ªÉn th·ªã l·ªói r√µ r√†ng
      const errorNotif = document.createElement('div');
      errorNotif.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px 20px; border-radius: 4px; font-size: 14px; z-index: 9999; box-shadow: 0 4px 6px rgba(0,0,0,0.2); max-width: 300px;';
      errorNotif.innerHTML = `<i class="bi bi-exclamation-circle"></i> <strong>Sync th·∫•t b·∫°i</strong><br><small>${error.message}</small><br><small style="opacity:0.8;">Ki·ªÉm tra: Token h·ª£p l·ªá? Gist ID ƒë√∫ng?</small>`;
      document.body.appendChild(errorNotif);
      setTimeout(() => errorNotif.remove(), 5000);
      
      alert('‚úó L·ªói sync: ' + error.message + '\n\nKi·ªÉm tra:\n1. Token h·ª£p l·ªá?\n2. Gist ID ch√≠nh x√°c?\n3. K·∫øt n·ªëi Internet?');
    }
  }

  async function loadFromGitHub() {
    const settings = getGitHubSettings();
    
    if (!settings.token || !settings.gistId) {
      return; // GitHub ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh
    }

    try {
      const response = await fetchWithTimeout(
        `https://api.github.com/gists/${settings.gistId}`,
        {
          headers: {
            'Authorization': `token ${settings.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        },
        10000 // 10 gi√¢y timeout
      );

      if (response.ok) {
        const gist = await response.json();
        if (gist.files['cameras.json']) {
          const content = gist.files['cameras.json'].content;
          const data = JSON.parse(content);
          if (Array.isArray(data) && data.length > 0) {
            // H·ª£p nh·∫•t thay v√¨ ghi ƒë√® khi t·∫£i trang
            cameras = mergeCameraLists(cameras, data);
            saveCameras();
            console.log('‚úì D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c h·ª£p nh·∫•t t·ª´ GitHub');
          }
        }
      } else if (response.status === 401) {
        console.warn('GitHub Token kh√¥ng h·ª£p l·ªá');
      }
    } catch (error) {
      console.log('Kh√¥ng th·ªÉ t·∫£i t·ª´ GitHub:', error.message);
    }
  }

  // H√†m t·∫£i d·ªØ li·ªáu t·ª´ localStorage
  async function loadCameras() {
    // C·ªë g·∫Øng t·∫£i t·ª´ GitHub tr∆∞·ªõc
    await loadFromGitHub();
    
    const stored = localStorage.getItem(STORAGE_KEYS.cameras);
    if (stored) {
      cameras = JSON.parse(stored);
    }
  }

  // H√†m l∆∞u d·ªØ li·ªáu v√†o localStorage
  function saveCameras() {
    try {
      localStorage.setItem(STORAGE_KEYS.cameras, JSON.stringify(cameras));
      showSaveNotification();
      console.log('‚úì D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o localStorage');
    } catch (error) {
      console.error('L·ªói l∆∞u d·ªØ li·ªáu:', error);
      alert('Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t tr√¨nh duy·ªát c·ªßa b·∫°n.');
    }
  }

  // H√†m hi·ªÉn th·ªã th√¥ng b√°o l∆∞u th√†nh c√¥ng (ch·ªâ tr√™n mobile/desktop nh·ªè)
  function showSaveNotification() {
    const notif = document.createElement('div');
    notif.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 4px; font-size: 14px; z-index: 9999; animation: slideIn 0.3s ease-in-out;';
    notif.textContent = '‚úì D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u';
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 2000);
  }

  // H√†m x√≥a d·ªØ li·ªáu t·ª´ localStorage
  function clearStorageData() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu camera kh√¥ng?')) {
      localStorage.removeItem(STORAGE_KEYS.cameras);
      alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x√≥a.');
      location.reload();
    }
  }

  function generateRandomCameras(total = 200) {
    const centerLat = 11.9404;
    const centerLng = 108.4583;
    const maxDelta = 0.2;
    for (let i = 1; i <= total; i++) {
      const lat = centerLat + (Math.random() - 0.5) * maxDelta;
      const lng = centerLng + (Math.random() - 0.5) * maxDelta;
      const status = Math.random() > 0.3 ? 'online' : 'offline';
      const ip = `192.168.${Math.floor((i - 1) / 254)}.${((i - 1) % 254) + 1}`;
      cameras.push({ id: i, name: `Camera ${i}`, ip, address: `ƒê·ªãa ch·ªâ ${i}`, lat, lng, status });
    }
  }

  const markers = L.markerClusterGroup();

  function updateStats() {
    const activeCameras = cameras.filter(c => !c.deleted);
    const total = activeCameras.length;
    const online = activeCameras.filter(c => c.status === 'online').length;
    const offline = total - online;
    document.getElementById('totalCount').textContent = total;
    document.getElementById('onlineCount').textContent = online;
    document.getElementById('offlineCount').textContent = offline;
  }

  function renderMarkers() {
    markers.clearLayers();
    const showOnline = document.getElementById('filterOnline').checked;
    const showOffline = document.getElementById('filterOffline').checked;
    cameras.filter(cam => !cam.deleted && ((cam.status === 'online' && showOnline) || (cam.status === 'offline' && showOffline)))
      .forEach(cam => {
        const marker = L.marker([cam.lat, cam.lng], { icon: cam.status === 'online' ? onlineIcon : offlineIcon });
        marker.bindPopup(`<b>${cam.name}</b><br>${cam.address}`);
        markers.addLayer(marker);
      });
    map.addLayer(markers);
  }

  function renderTable() {
    const tbody = document.getElementById('cameraTable');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const showOnline = document.getElementById('filterOnline').checked;
    const showOffline = document.getElementById('filterOffline').checked;
    tbody.innerHTML = '';
    let rowNum = 1;
    cameras.filter(cam => {
      if (cam.deleted) return false;
      const matchesSearch = cam.name.toLowerCase().includes(searchTerm) || cam.ip.toLowerCase().includes(searchTerm);
      const matchesStatus = (cam.status === 'online' && showOnline) || (cam.status === 'offline' && showOffline);
      return matchesSearch && matchesStatus;
    }).forEach(cam => {
      const row = document.createElement('tr');
      row.style.cursor = 'pointer';
      row.onclick = () => focusCamera(cam);
      row.innerHTML = `<td>${rowNum++}</td><td>${cam.name}</td><td>${cam.ip}</td><td>${cam.address}</td>
        <td>${cam.lat.toFixed(4)}</td><td>${cam.lng.toFixed(4)}</td>
        <td><span class='${cam.status}'>${cam.status}</span></td>
        <td><button class='btn btn-sm btn-warning' onclick='event.stopPropagation(); editCamera("${cam.id}")'>S·ª≠a</button>
        <button class='btn btn-sm btn-danger' onclick='event.stopPropagation(); deleteCamera("${cam.id}")'>X√≥a</button></td>`;
      tbody.appendChild(row);
    });
  }

  function editCamera(id) {
    // S·ª≠ d·ª•ng so s√°nh l·ªèng (==) ƒë·ªÉ h·ªó tr·ª£ c·∫£ ID s·ªë c≈© v√† ID chu·ªói m·ªõi
    const cam = cameras.find(c => c.id == id);
    document.getElementById('editId').value = id;
    document.getElementById('editName').value = cam.name;
    document.getElementById('editIP').value = cam.ip;
    document.getElementById('editAddress').value = cam.address;
    document.getElementById('editLat').value = cam.lat;
    document.getElementById('editLng').value = cam.lng;
    document.getElementById('editStatus').value = cam.status;
    new bootstrap.Modal(document.getElementById('editModal')).show();
  }

  function saveEdit() {
    const id = document.getElementById('editId').value;
    const cam = cameras.find(c => c.id == id);
    cam.name = document.getElementById('editName').value;
    cam.ip = document.getElementById('editIP').value;
    cam.address = document.getElementById('editAddress').value;
    cam.lat = parseFloat(document.getElementById('editLat').value);
    cam.lng = parseFloat(document.getElementById('editLng').value);
    cam.status = document.getElementById('editStatus').value;
    cam.updatedAt = Date.now(); // C·∫≠p nh·∫≠t th·ªùi gian s·ª≠a
    saveCameras();
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    renderMarkers(); renderTable(); updateStats();
  }

  function togglePinMode() {
    isPinMode = !isPinMode;
    const pinBtn = document.getElementById('pinBtn');
    if (isPinMode) {
      pinBtn.classList.add('pin-mode-active');
      document.getElementById('map').parentElement.classList.add('pin-mode');
      map.dragging.disable();
    } else {
      pinBtn.classList.remove('pin-mode-active');
      document.getElementById('map').parentElement.classList.remove('pin-mode');
      map.dragging.enable();
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
    }
  }

  function saveNewCamera() {
    const name = document.getElementById('addName').value.trim();
    const ip = document.getElementById('addIP').value.trim();
    const address = document.getElementById('addAddress').value.trim();
    const lat = parseFloat(document.getElementById('addLat').value);
    const lng = parseFloat(document.getElementById('addLng').value);
    const status = document.getElementById('addStatus').value;

    if (!name || !ip || !address) {
      alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
      return;
    }

    // T·∫°o ID duy nh·∫•t d·ª±a tr√™n th·ªùi gian + chu·ªói ng·∫´u nhi√™n ƒë·ªÉ tr√°nh tr√πng l·∫∑p khi nhi·ªÅu ng∆∞·ªùi c√πng th√™m
    const newId = 'cam_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    cameras.push({ id: newId, name, ip, address, lat, lng, status, updatedAt: Date.now() });
    saveCameras();

    // Reset form
    document.getElementById('addName').value = '';
    document.getElementById('addIP').value = '';
    document.getElementById('addAddress').value = '';
    document.getElementById('addLat').value = '';
    document.getElementById('addLng').value = '';
    document.getElementById('addStatus').value = 'online';

    bootstrap.Modal.getInstance(document.getElementById('addCameraModal')).hide();
    renderMarkers(); renderTable(); updateStats();

    // T·∫Øt ch·∫ø ƒë·ªô ghim
    if (isPinMode) {
      togglePinMode();
    }
  }

  function deleteCamera(id) {
    // X√≥a m·ªÅm (Soft Delete) ƒë·ªÉ ƒë·ªìng b·ªô ƒë∆∞·ª£c vi·ªác x√≥a
    const cam = cameras.find(c => c.id == id);
    if (cam) {
      cam.deleted = true;
      cam.updatedAt = Date.now();
      saveCameras();
      renderMarkers(); renderTable(); updateStats();
    }
  }

  function addCamera() {
    // Reset form
    document.getElementById('addName').value = '';
    document.getElementById('addIP').value = '';
    document.getElementById('addAddress').value = '';
    document.getElementById('addLat').value = '';
    document.getElementById('addLng').value = '';
    document.getElementById('addStatus').value = 'offline';
    new bootstrap.Modal(document.getElementById('addCameraModal')).show();
  }

  function exportCSV() {
    let csv = 'T√™n,IP,ƒê·ªãa ch·ªâ,Vƒ© ƒë·ªô,Kinh ƒë·ªô,Tr·∫°ng th√°i\n';
    cameras.filter(c => !c.deleted).forEach(cam => {
      csv += `"${cam.name}","${cam.ip}","${cam.address}",${cam.lat.toFixed(5)},${cam.lng.toFixed(5)},"${cam.status}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'cameras.csv';
    link.click();
  }

  function importCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const lines = e.target.result.split('\n').slice(1);
      const newCameras = [];
      lines.forEach((line, index) => {
        if (line.trim()) {
          const cols = line.split(',').map(col => col.replace(/"/g, '').trim());
          if (cols.length >= 6) {
            // T·∫°o ID duy nh·∫•t cho file import
            const id = 'import_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2, 5);
            newCameras.push({ id: id, name: cols[0], ip: cols[1], address: cols[2],
              lat: parseFloat(cols[3]), lng: parseFloat(cols[4]), status: cols[5], updatedAt: Date.now() });
          }
        }
      });
      cameras = cameras.concat(newCameras);
      saveCameras();
      document.getElementById('importFile').value = '';
      renderMarkers(); renderTable(); updateStats();
      alert(`ƒê√£ nh·∫≠p ${newCameras.length} camera`);
    };
    reader.readAsText(file, 'UTF-8');
  }

  function toggleFilter(type) {
    const checkbox = document.getElementById('filter' + type.charAt(0).toUpperCase() + type.slice(1));
    checkbox.checked = !checkbox.checked;
    renderMarkers(); renderTable();
  }

  // Event listener cho map click trong ch·∫ø ƒë·ªô ghim
  map.on('click', function(e) {
    if (!isPinMode) return;

    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // X√≥a marker t·∫°m th·ªùi c≈©
    if (tempMarker) {
      map.removeLayer(tempMarker);
    }

    // Th√™m marker t·∫°m th·ªùi v·ªõi m√†u v√†ng
    tempMarker = L.marker([lat, lng], { icon: tempIcon });
    tempMarker.addTo(map);

    // ƒêi·ªÅn t·ªça ƒë·ªô v√†o form
    document.getElementById('addLat').value = lat.toFixed(5);
    document.getElementById('addLng').value = lng.toFixed(5);

    // M·ªü modal th√™m camera
    new bootstrap.Modal(document.getElementById('addCameraModal')).show();
  });

  document.getElementById('filterOnline').addEventListener('change', () => { renderMarkers(); renderTable(); updateStats(); });
  document.getElementById('filterOffline').addEventListener('change', () => { renderMarkers(); renderTable(); updateStats(); });
  document.getElementById('searchInput').addEventListener('input', () => { renderTable(); });

  // Event khi modal ƒë√≥ng l·∫°i
  document.getElementById('addCameraModal').addEventListener('hidden.bs.modal', function() {
    if (tempMarker) {
      map.removeLayer(tempMarker);
      tempMarker = null;
    }
  });

  document.addEventListener('DOMContentLoaded', async function() {
    await loadCameras();
    renderMarkers(); renderTable(); updateStats();
  });

  function focusCamera(cam) {
    map.setView([cam.lat, cam.lng], 17);
    const popup = L.popup()
      .setLatLng([cam.lat, cam.lng])
      .setContent(`<b>${cam.name}</b><br>${cam.address}`)
      .openOn(map);
  }
</script>
</body>
</html>
